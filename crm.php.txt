<?php
// 1. DEFINIÇÕES E CONEXÃO
$db_file = __DIR__ . '/crm.db';
$db = new PDO("sqlite:$db_file");
$db->exec("PRAGMA foreign_keys = ON;");

// Constantes para o funil de vendas
define('ETAPAS_FUNIL', [
    'Prospecção',
    'Proposta',
    'Negociação',
    'Fechado Ganho',
    'Fechado Perdido'
]);

// Função helper para formatar moeda
function formatar_brl($valor) {
    return 'R$ ' . number_format($valor, 2, ',', '.');
}

// == CRIAÇÃO DAS TABELAS ==
// Tabelas 'empresas' e 'contatos' (inalteradas da v3)
$db->exec("CREATE TABLE IF NOT EXISTS empresas (
    id INTEGER PRIMARY KEY AUTOINCREMENT, nome TEXT NOT NULL UNIQUE, site TEXT
)");
$db->exec("CREATE TABLE IF NOT EXISTS contatos (
    id INTEGER PRIMARY KEY AUTOINCREMENT, nome TEXT NOT NULL, email TEXT,
    telefone TEXT, status TEXT DEFAULT 'Lead', empresa_id INTEGER,
    FOREIGN KEY (empresa_id) REFERENCES empresas(id) ON DELETE SET NULL
)");
// Tabela 'interacoes' (inalterada da v3)
$db->exec("CREATE TABLE IF NOT EXISTS interacoes (
    id INTEGER PRIMARY KEY AUTOINCREMENT, contato_id INTEGER NOT NULL, tipo TEXT,
    notas TEXT, data_interacao DATETIME DEFAULT CURRENT_TIMESTAMP,
    FOREIGN KEY (contato_id) REFERENCES contatos(id) ON DELETE CASCADE
)");

// NOVO: Tabela 'negocios' (Oportunidades)
$db->exec("CREATE TABLE IF NOT EXISTS negocios (
    id INTEGER PRIMARY KEY AUTOINCREMENT,
    titulo TEXT NOT NULL,
    valor REAL DEFAULT 0,
    etapa TEXT DEFAULT 'Prospecção', -- Prospecção, Proposta, Negociação, Fechado Ganho, Fechado Perdido
    criado_em DATETIME DEFAULT CURRENT_TIMESTAMP,
    contato_id INTEGER NOT NULL,
    empresa_id INTEGER,
    
    FOREIGN KEY (contato_id) REFERENCES contatos(id) ON DELETE CASCADE,
    FOREIGN KEY (empresa_id) REFERENCES empresas(id) ON DELETE SET NULL
)");

$erro = '';
$sucesso = '';
$busca = $_GET['q'] ?? '';
$acao = $_POST['acao'] ?? '';
$ver_contato_id = (int)($_GET['ver_contato'] ?? 0);

// 2. LÓGICA DE AÇÕES (CRUD) - POST
// ... (Ações 'add_empresa', 'add_contato', 'add_interacao' da v3 permanecem aqui) ...
// (Para manter o foco, o código repetido foi omitido desta exibição, mas ele deve estar aqui)

// == AÇÃO: ADICIONAR EMPRESA ==
if ($_SERVER['REQUEST_METHOD'] == 'POST' && $acao == 'add_empresa') {
    $nome_empresa = trim($_POST['nome_empresa']);
    $site_empresa = trim($_POST['site_empresa'] ?? '');
    if (!empty($nome_empresa)) {
        try {
            $stmt = $db->prepare("INSERT INTO empresas (nome, site) VALUES (?, ?)");
            $stmt->execute([$nome_empresa, $site_empresa]);
            $sucesso = "Empresa '$nome_empresa' adicionada!";
        } catch (PDOException $e) {
            if (str_contains($e->getMessage(), 'UNIQUE constraint failed')) {
                $erro = "Erro: Já existe uma empresa com esse nome.";
            } else { $erro = "Erro ao adicionar empresa: " . $e->getMessage(); }
        }
    } else { $erro = "O nome da empresa é obrigatório."; }
}

// == AÇÃO: ADICIONAR CONTATO ==
if ($_SERVER['REQUEST_METHOD'] == 'POST' && $acao == 'add_contato') {
    $nome = trim($_POST['nome']);
    $email = trim($_POST['email'] ?? '');
    $telefone = trim($_POST['telefone'] ?? '');
    $empresa_id = (!empty($_POST['empresa_id'])) ? (int)$_POST['empresa_id'] : null;
    if (!empty($nome)) {
        $stmt = $db->prepare("INSERT INTO contatos (nome, email, telefone, status, empresa_id) VALUES (?, ?, ?, 'Lead', ?)");
        $stmt->execute([$nome, $email, $telefone, $empresa_id]);
        header('Location: ' . $_SERVER['PHP_SELF'] . '#lista-contatos'); exit;
    } else { $erro = "O nome do contato é obrigatório."; }
}

// == AÇÃO: ADICIONAR INTERAÇÃO == (Na página de detalhes)
if ($_SERVER['REQUEST_METHOD'] == 'POST' && $acao == 'add_interacao') {
    $contato_id = (int)$_POST['contato_id'];
    $tipo = trim($_POST['tipo']);
    $notas = trim($_POST['notas']);
    if ($contato_id > 0 && !empty($notas)) {
        $stmt = $db->prepare("INSERT INTO interacoes (contato_id, tipo, notas) VALUES (?, ?, ?)");
        $stmt->execute([$contato_id, $tipo, $notas]);
        header('Location: ' . $_SERVER['PHP_SELF'] . '?ver_contato=' . $contato_id); exit;
    } else {
        $erro = "Erro ao salvar interação. As notas não podem estar vazias.";
        $ver_contato_id = $contato_id;
    }
}

// == NOVO: AÇÃO: ADICIONAR NEGÓCIO ==
if ($_SERVER['REQUEST_METHOD'] == 'POST' && $acao == 'add_negocio') {
    $titulo = trim($_POST['titulo']);
    // Trata valores como '1.000,50' ou '1000.50'
    $valor = (float)str_replace(',', '.', str_replace('.', '', $_POST['valor'] ?? 0));
    $etapa = trim($_POST['etapa']);
    $contato_id = (int)$_POST['contato_id'];

    // Um negócio DEVE ter um título e um contato
    if (empty($titulo) || $contato_id == 0) {
        $erro = "Título e Contato são obrigatórios para criar um negócio.";
    } elseif (!in_array($etapa, ETAPAS_FUNIL)) {
        $erro = "Etapa do funil inválida.";
    } else {
        // Busca automaticamente a empresa do contato selecionado
        $stmt_emp = $db->prepare("SELECT empresa_id FROM contatos WHERE id = ?");
        $stmt_emp->execute([$contato_id]);
        $empresa_id = $stmt_emp->fetchColumn();

        if (!$empresa_id) {
            $erro = "O contato selecionado precisa estar associado a uma empresa para criar um negócio.";
        } else {
            $stmt = $db->prepare("INSERT INTO negocios (titulo, valor, etapa, contato_id, empresa_id) VALUES (?, ?, ?, ?, ?)");
            $stmt->execute([$titulo, $valor, $etapa, $contato_id, $empresa_id]);
            header('Location: ' . $_SERVER['PHP_SELF'] . '#funil'); exit;
        }
    }
}


// == AÇÕES GET (Atualizar / Remover) ==
// ... (remover_contato, remover_empresa, mudar_status, remover_interacao da v3) ...
// (Para manter o foco, o código repetido foi omitido desta exibição, mas ele deve estar aqui)

// REMOVER CONTATO
if (isset($_GET['remover_contato'])) {
    $id = (int)$_GET['remover_contato'];
    $stmt = $db->prepare("DELETE FROM contatos WHERE id = ?"); $stmt->execute([$id]);
    header('Location: ' . $_SERVER['PHP_SELF'] . '#lista-contatos'); exit;
}
// REMOVER EMPRESA
if (isset($_GET['remover_empresa'])) {
    $id = (int)$_GET['remover_empresa'];
    $stmt = $db->prepare("DELETE FROM empresas WHERE id = ?"); $stmt->execute([$id]);
    header('Location: ' . $_SERVER['PHP_SELF'] . '#lista-empresas'); exit;
}
// ATUALIZAR STATUS DO CONTATO
if (isset($_GET['mudar_status'])) {
    $id = (int)$_GET['mudar_status'];
    $stmt_busca = $db->prepare("SELECT status FROM contatos WHERE id = ?"); $stmt_busca->execute([$id]);
    $contato_atual = $stmt_busca->fetch(PDO::FETCH_ASSOC);
    if ($contato_atual) {
        $novo_status = ($contato_atual['status'] == 'Lead') ? 'Cliente' : 'Lead';
        $stmt_update = $db->prepare("UPDATE contatos SET status = ? WHERE id = ?");
        $stmt_update->execute([$novo_status, $id]);
        header('Location: ' . $_SERVER['PHP_SELF'] . '#lista-contatos'); exit;
    }
}
// REMOVER INTERAÇÃO
if (isset($_GET['remover_interacao'])) {
    $id = (int)$_GET['remover_interacao'];
    $id_contato_redirect = (int)$_GET['id_contato'];
    $stmt = $db->prepare("DELETE FROM interacoes WHERE id = ?"); $stmt->execute([$id]);
    header('Location: ' . $_SERVER['PHP_SELF'] . '?ver_contato=' . $id_contato_redirect); exit;
}

// == NOVO: AÇÕES GET (NEGÓCIOS) ==
if (isset($_GET['remover_negocio'])) {
    $id = (int)$_GET['remover_negocio'];
    $stmt = $db->prepare("DELETE FROM negocios WHERE id = ?");
    $stmt->execute([$id]);
    header('Location: ' . $_SERVER['PHP_SELF'] . '#funil'); exit;
}

if (isset($_GET['mudar_etapa'])) {
    $id = (int)$_GET['mudar_etapa'];
    $nova_etapa = $_GET['nova_etapa'];
    
    // Valida se a etapa de destino é uma etapa válida
    if (in_array($nova_etapa, ETAPAS_FUNIL)) {
        $stmt = $db->prepare("UPDATE negocios SET etapa = ? WHERE id = ?");
        $stmt->execute([$nova_etapa, $id]);
    }
    header('Location: ' . $_SERVER['PHP_SELF'] . '#funil'); exit;
}


// 3. LÓGICA DE LEITURA E EXIBIÇÃO
if ($ver_contato_id > 0) {
    // == MODO: PÁGINA DE DETALHES DO CONTATO ==
    // ... (Código da v3 para buscar $contato e $lista_interacoes) ...
    $sql_contato = "SELECT c.*, e.nome AS nome_empresa FROM contatos c LEFT JOIN empresas e ON c.empresa_id = e.id WHERE c.id = ?";
    $stmt_contato = $db->prepare($sql_contato);
    $stmt_contato->execute([$ver_contato_id]);
    $contato = $stmt_contato->fetch(PDO::FETCH_ASSOC);
    if (!$contato) { header('Location: '.'crm.php'); exit; }
    $stmt_interacoes = $db->prepare("SELECT * FROM interacoes WHERE contato_id = ? ORDER BY data_interacao DESC");
    $stmt_interacoes->execute([$ver_contato_id]);
    $lista_interacoes = $stmt_interacoes->fetchAll(PDO::FETCH_ASSOC);

} else {
    // == MODO: PÁGINA PRINCIPAL (LISTAS + FUNIL) ==
    
    // 1. Carregar EMPRESAS
    $lista_empresas = $db->query("SELECT * FROM empresas ORDER BY nome ASC")->fetchAll(PDO::FETCH_ASSOC);

    // 2. Carregar CONTATOS (com JOIN e busca)
    $listaParaMostrar = [];
    $sql_busca = "SELECT c.*, e.nome AS nome_empresa FROM contatos c LEFT JOIN empresas e ON c.empresa_id = e.id";
    if ($busca != '') {
        $sql_busca .= " WHERE c.nome LIKE ? OR c.email LIKE ? OR e.nome LIKE ?";
        $stmt = $db->prepare($sql_busca . " ORDER BY c.nome ASC");
        $termo_busca = '%' . $busca . '%';
        $stmt->execute([$termo_busca, $termo_busca, $termo_busca]);
    } else {
        $stmt = $db->query($sql_busca . " ORDER BY c.nome ASC");
    }
    $listaParaMostrar = $stmt->fetchAll(PDO::FETCH_ASSOC);
    
    // 3. Carregar CONTATOS (para dropdown de Negócios)
    // Só queremos contatos QUE JÁ TÊM empresa
    $lista_contatos_dropdown = $db->query("
        SELECT contatos.id, contatos.nome, empresas.nome AS nome_empresa 
        FROM contatos 
        JOIN empresas ON contatos.empresa_id = empresas.id 
        ORDER BY contatos.nome
    ")->fetchAll(PDO::FETCH_ASSOC);

    // 4. Carregar TODOS OS NEGÓCIOS (com JOINs)
    $sql_negocios = "
        SELECT 
            negocios.*,
            contatos.nome AS nome_contato,
            empresas.nome AS nome_empresa
        FROM negocios
        JOIN contatos ON negocios.contato_id = contatos.id
        JOIN empresas ON negocios.empresa_id = empresas.id
        ORDER BY negocios.criado_em DESC
    ";
    $todos_negocios = $db->query($sql_negocios)->fetchAll(PDO::FETCH_ASSOC);

    // 5. Organizar negócios em "baldes" (buckets) para o Kanban
    // E calcular o total em R$ por etapa
    $negocios_por_etapa = [];
    $valor_por_etapa = [];
    foreach (ETAPAS_FUNIL as $etapa) {
        $negocios_por_etapa[$etapa] = [];
        $valor_por_etapa[$etapa] = 0;
    }
    foreach ($todos_negocios as $negocio) {
        $negocios_por_etapa[$negocio['etapa']][] = $negocio;
        $valor_por_etapa[$negocio['etapa']] += $negocio['valor'];
    }
    
    $total_contatos = $db->query("SELECT COUNT(*) FROM contatos")->fetchColumn();
    $total_empresas = $db->query("SELECT COUNT(*) FROM empresas")->fetchColumn();
}
?>
<!DOCTYPE html>
<html lang="pt-br">
<head>
<meta charset="utf-8">
<title>Meu CRM (v4 - Funil)</title>
<meta name=viewport content="width=device-width, initial-scale=1">
<style>
    /* ... (CSS principal da v3) ... */
    body{font-family: Arial, sans-serif;margin:30px;line-height:1.4; background: #f0f2f5;}
    .app{max-width: 90%; /* Aumentamos a largura para o funil */ margin:auto; background: #fff; padding: 20px; border-radius: 8px; box-shadow: 0 2px 8px rgba(0,0,0,0.05);}
    h1{margin:0 0 16px}
    h2{border-bottom: 2px solid #eee; padding-bottom: 8px;}
    
    form.add{display:flex;flex-wrap:wrap;gap:8px;margin-bottom:14px;background:#f9f9f9;padding:15px;border-radius:6px}
    form.add input[type=text], form.add select, form.add textarea {flex:1 1 180px;padding:10px;border:1px solid #ccc;border-radius:6px}
    form.add textarea { flex-basis: 100%; min-height: 80px; }
    form.add button{flex:1 1 100px;padding:10px 14px;border:0;background:#1f7ae0;color:#fff;border-radius:6px;cursor:pointer}
    form.add label { font-size: 0.9em; flex-basis: 100%; }

    .t{display:flex;align-items:center;justify-content:space-between;border:1px solid #eee;padding:10px;border-radius:6px;margin:6px 0}
    .t.cliente{text-decoration:line-through;color:#555;background:#f4fff4}
    .t .info { flex: 1; }
    .t .info small { color: #777; display: block; }
    .t .info .empresa { font-weight: bold; color: #1f7ae0; font-size: 0.9em; }

    .acoes a{margin-left:10px;text-decoration:none; font-size: 0.9em;}
    .msg-erro{color:#b00020;margin:8px 0; background: #ffe0e0; padding: 10px; border-radius: 6px;}
    .msg-sucesso{color:#006b21;margin:8px 0; background: #e0ffe8; padding: 10px; border-radius: 6px;}
    .busca{margin: 10px 0 18px; display: flex; gap: 8px;}
    .busca input[type=text] { flex: 1; }
    small{color:#777}
    
    /* ... (CSS da Página de Detalhes da v3) ... */
    .detalhe-header { margin-bottom: 20px; } .detalhe-header h1 { font-size: 2.2em; margin-bottom: 5px; } .detalhe-header .empresa-link { color: #1f7ae0; text-decoration: none; font-size: 1.2em; font-weight: bold; } .detalhe-info { margin-bottom: 20px; } .detalhe-info p { margin: 5px 0; } .link-voltar { display: inline-block; margin-bottom: 20px; text-decoration: none; background: #eee; padding: 8px 12px; border-radius: 6px; color: #333; } .interacao { border: 1px solid #f0f0f0; background: #fafafa; padding: 10px; border-radius: 6px; margin-bottom: 10px; } .interacao-header { display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid #eee; padding-bottom: 5px; margin-bottom: 8px; } .interacao-header strong { background: #eee; padding: 3px 8px; border-radius: 4px; font-size: 0.9em; } .interacao-header small { color: #777; } .interacao-header a { font-size: 0.8em; color: #b00020; } .interacao-notas { white-space: pre-wrap; }

    /* NOVO: ESTILOS DO KANBAN */
    .kanban-container {
        display: flex;
        gap: 12px;
        overflow-x: auto; /* Permite rolar se não couber na tela */
        padding: 10px 0 20px 0;
    }
    .kanban-coluna {
        flex: 1 0 280px; /* Base de 280px, mas pode crescer */
        min-width: 280px;
        background: #f4f4f4;
        border-radius: 6px;
        padding: 10px;
    }
    .kanban-coluna h3 {
        margin: 0 0 5px 0;
        font-size: 1em;
        text-transform: uppercase;
        color: #555;
    }
    .kanban-coluna-header {
        border-bottom: 2px solid #ddd;
        padding-bottom: 8px;
        margin-bottom: 8px;
    }
    .kanban-coluna-header small {
        font-weight: bold;
        color: #333;
    }
    .negocio-card {
        background: #fff;
        border: 1px solid #ddd;
        border-radius: 6px;
        padding: 12px;
        margin-bottom: 10px;
        box-shadow: 0 1px 3px rgba(0,0,0,0.05);
    }
    .negocio-card strong {
        font-size: 1.1em;
        display: block;
        margin-bottom: 5px;
    }
    .negocio-card .valor {
        font-size: 1.2em;
        color: #006b21;
        font-weight: bold;
        margin-bottom: 10px;
    }
    .negocio-card small {
        display: block;
        line-height: 1.3;
        color: #555;
    }
    .negocio-card-acoes {
        margin-top: 10px;
        padding-top: 10px;
        border-top: 1px dashed #eee;
    }
    .negocio-card-acoes summary { cursor: pointer; font-weight: bold; font-size: 0.9em; }
    .negocio-card-acoes a {
        display: block;
        padding: 4px 0;
        text-decoration: none;
        font-size: 0.9em;
    }
</style>
</head>
<body>
<div class="app">

    <?php if (!empty($erro)): ?>
        <div class="msg-erro"><?= htmlspecialchars($erro) ?></div>
    <?php endif ?>
    <?php if (!empty($sucesso)): ?>
        <div class="msg-sucesso"><?= htmlspecialchars($sucesso) ?></div>
    <?php endif ?>

    <?php if ($ver_contato_id > 0): ?>
    <a href="crm.php" class="link-voltar">&larr; Voltar para a lista</a>

        <div class="detalhe-header">
            <h1><?= htmlspecialchars($contato['nome']) ?></h1>
            <?php if (!empty($contato['nome_empresa'])): ?>
                <a href="#" class="empresa-link"><?= htmlspecialchars($contato['nome_empresa']) ?></a>
            <?php else: ?>
                <span style="opacity: 0.5;"><i>Sem empresa</i></span>
            <?php endif; ?>
        </div>
        <div class="detalhe-info">
            <p><strong>Email:</strong> <?= htmlspecialchars($contato['email']) ?: 'N/D' ?></p>
            <p><strong>Telefone:</strong> <?= htmlspecialchars($contato['telefone']) ?: 'N/D' ?></p>
            <p><strong>Status:</strong> <?= htmlspecialchars($contato['status']) ?></p>
        </div>
        <h2 style="margin-top: 40px;">Histórico de Interações</h2>
        <form method="post" class="add" action="crm.php">
            <input type="hidden" name="acao" value="add_interacao">
            <input type="hidden" name="contato_id" value="<?= $contato['id'] ?>">
            <select name="tipo" style="flex-grow: 0; flex-basis: 150px;"> <option value="Telefone">Telefone</option> <option value="Email">Email</option> <option value="Reunião">Reunião</option> <option value="Nota">Nota</option> </select>
            <textarea name="notas" placeholder="Digite os detalhes do contato..." required></textarea>
            <button type="submit" style="flex-basis: 100%;">Salvar Interação</button>
        </form>
        <?php if (count($lista_interacoes) == 0): ?>
            <p><em>Nenhuma interação registrada.</em></p>
        <?php else: ?>
            <?php foreach($lista_interacoes as $inter): ?>
                <div class="interacao">
                    <div class="interacao-header">
                        <div> <strong><?= htmlspecialchars($inter['tipo']) ?></strong> <small><?= date('d/m/Y H:i', strtotime($inter['data_interacao'])) ?></small> </div>
                        <a href="?remover_interacao=<?= $inter['id'] ?>&id_contato=<?= $contato['id'] ?>" onclick="return confirm('Remover esta interação?')">[remover]</a>
                    </div>
                    <div class="interacao-notas"><?= htmlspecialchars($inter['notas']) ?></div>
                </div>
            <?php endforeach; ?>
        <?php endif; ?>


    <?php else: ?>
    <h1>Meu CRM (v4: Funil de Vendas)</h1>

        <h2 id="funil">Funil de Vendas (Negócios)</h2>
        <form method="post" class="add" action="crm.php#funil">
            <input type="hidden" name="acao" value="add_negocio">
            
            <input type="text" name="titulo" placeholder="Título do Negócio" required style="flex-basis: 100%;">
            
            <input type="text" name="valor" placeholder="Valor (ex: 1500,50)" style="flex-grow: 1;">
            
            <select name="etapa" style="flex-grow: 1;">
                <?php foreach(ETAPAS_FUNIL as $etapa): ?>
                    <?php if ($etapa == 'Fechado Perdido') continue; // Não adiciona direto em 'perdido' ?>
                    <option value="<?= $etapa ?>"><?= $etapa ?></option>
                <?php endforeach; ?>
            </select>

            <select name="contato_id" required style="flex-basis: 100%;">
                <option value="0">— Selecione um Contato (precisa ter empresa) —</option>
                <?php foreach($lista_contatos_dropdown as $c): ?>
                    <option value="<?= $c['id'] ?>"><?= htmlspecialchars($c['nome']) ?> (<?= htmlspecialchars($c['nome_empresa']) ?>)</option>
                <?php endforeach; ?>
            </select>
            
            <button type="submit" style="flex-basis: 100%;">Adicionar Negócio</button>
        </form>

        <div class="kanban-container">
            <?php foreach(ETAPAS_FUNIL as $etapa): ?>
                <div class="kanban-coluna">
                    <div class="kanban-coluna-header">
                        <h3><?= $etapa ?> (<?= count($negocios_por_etapa[$etapa]) ?>)</h3>
                        <small><?= formatar_brl($valor_por_etapa[$etapa]) ?></small>
                    </div>
                    
                    <?php foreach($negocios_por_etapa[$etapa] as $negocio): ?>
                        <div class="negocio-card">
                            <strong><?= htmlspecialchars($negocio['titulo']) ?></strong>
                            <div class="valor"><?= formatar_brl($negocio['valor']) ?></div>
                            <small>
                                Contato: <a href="?ver_contato=<?= $negocio['contato_id'] ?>"><?= htmlspecialchars($negocio['nome_contato']) ?></a>
                            </small>
                            <small>Empresa: <?= htmlspecialchars($negocio['nome_empresa']) ?></small>
                            
                            <div class="negocio-card-acoes">
                                <details>
                                    <summary>Ações</summary>
                                    <h5 style="margin: 5px 0 3px 0;">Mover para:</h5>
                                    <?php foreach(ETAPAS_FUNIL as $etapa_link): ?>
                                        <?php if ($negocio['etapa'] != $etapa_link): ?>
                                            <a href="?mudar_etapa=<?= $negocio['id'] ?>&nova_etapa=<?= urlencode($etapa_link) ?>"><?= $etapa_link ?></a>
                                        <?php endif; ?>
                                    <?php endforeach; ?>
                                    <hr style="border: 0; border-top: 1px dashed #eee; margin: 5px 0;">
                                    <a href="?remover_negocio=<?= $negocio['id'] ?>" onclick="return confirm('Remover este negócio?')" style="color: #b00020;">Remover</a>
                                </details>
                            </div>
                        </div>
                    <?php endforeach; ?>
                    
                    <?php if (count($negocios_por_etapa[$etapa]) == 0): ?>
                        <em style="font-size: 0.9em; color: #777;">Nenhum negócio aqui.</em>
                    <?php endif; ?>
                </div>
            <?php endforeach; ?>
        </div>


        <details style="margin-top: 30px;">
            <summary><h2 style="display: inline-block;">Gerenciar Contatos (<?= $total_contatos ?>) e Empresas (<?= $total_empresas ?>)</h2></summary>
            
            <h3 id="lista-empresas">Empresas</h3>
            <form method="post" class="add" action="crm.php#lista-empresas">
                <input type="hidden" name="acao" value="add_empresa"> <input type="text" name="nome_empresa" placeholder="Nome da Empresa" required> <input type="text" name="site_empresa" placeholder="www.site.com"> <button type="submit">Adicionar Empresa</button>
            </form>
            <?php foreach($lista_empresas as $e): ?>
                <div class="t">
                    <div class="info"> <strong><?= htmlspecialchars($e['nome']) ?></strong> <small><?= htmlspecialchars($e['site']) ?></small> </div>
                    <div class="acoes"> <a href="?remover_empresa=<?= $e['id'] ?>" onclick="return confirm('Remover esta empresa?')">[remover]</a> </div>
                </div>
            <?php endforeach; ?>

            <h3 id="lista-contatos" style="margin-top: 40px;">Contatos</h3>
            <form method="post" class="add" action="crm.php#lista-contatos">
                <input type="hidden" name="acao" value="add_contato"> <input type="text" name="nome" placeholder="Nome do contato" required> <input type="text" name="email" placeholder="email@dominio.com"> <input type="text" name="telefone" placeholder="(00) 99999-9999">
                <select name="empresa_id">
                    <option value="0">— Selecione uma empresa (Opcional) —</option>
                    <?php foreach($lista_empresas as $e): ?> <option value="<?= $e['id'] ?>"><?= htmlspecialchars($e['nome']) ?></option> <?php endforeach; ?>
                </select>
                <button type="submit" style="flex-basis: 100%;">Adicionar Contato</button>
            </form>
            <form method="get" class="busca" action="crm.php#lista-contatos">
                <input type="text" name="q" value="<?= htmlspecialchars($busca) ?>" placeholder="Buscar contato, email ou empresa..."> <button>Buscar</button>
                <?php if($busca!=''): ?> <a href="<?= $_SERVER['PHP_SELF'] ?>#lista-contatos">limpar</a> <?php endif; ?>
            </form>
            <?php foreach($listaParaMostrar as $c): ?>
                <div class="t <?= ($c['status'] == 'Cliente') ? 'cliente' : '' ?>">
                    <div class="info">
                        <a href="?ver_contato=<?= $c['id'] ?>" style="font-weight: bold; text-decoration: none;"><?= htmlspecialchars($c['nome']) ?></a>
                        <?php if (!empty($c['nome_empresa'])): ?> <span class="empresa"><?= htmlspecialchars($c['nome_empresa']) ?></span> <?php endif; ?>
                        <small><?= htmlspecialchars($c['email']) ?> | <?= htmlspecialchars($c['telefone']) ?></small>
                    </div>
                    <div class="acoes"> <a href="?mudar_status=<?= $c['id'] ?>">[<?= $c['status'] == 'Lead' ? 'Marcar Cliente' : 'Marcar Lead' ?>]</a> <a href="?remover_contato=<?= $c['id'] ?>" onclick="return confirm('Remover mesmo?')">[remover]</a> </div>
                </div>
            <?php endforeach; ?>
        </details>
        
    <?php endif; // Fim da lógica de exibição (if/else) ?>

</div>
</body>
</html>